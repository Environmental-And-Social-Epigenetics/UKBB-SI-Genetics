# 5_Colocalization: Testing Shared Causal Signals Between GWAS and eQTL

This module tests whether GWAS loci and molecular QTL loci (here eQTLs) are likely driven by the same causal variant(s). It is a key bridge from statistical association to potential regulatory mechanism.

## Biological significance

A GWAS locus near a gene does not automatically imply that gene is causal. Colocalization asks a stricter question:

> Is the GWAS signal and the eQTL signal in this region likely generated by a shared causal variant?

If yes, that supports a mechanistic hypothesis where trait risk may be mediated through expression of a specific gene in a specific tissue/cell context.

## Statistical framework (coloc ABF)

This pipeline uses `coloc.abf` (approximate Bayes factor framework), which evaluates five hypotheses per locus-gene/tissue pair:

- **H0**: no association with either trait
- **H1**: association with GWAS trait only
- **H2**: association with eQTL trait only
- **H3**: both associated, but different causal variants
- **H4**: both associated, shared causal variant

Posterior probabilities (`PP.H0` ... `PP.H4`) sum to 1.

Key interpretation:

- High `PP.H4` -> strong evidence for shared causal signal (colocalization).
- High `PP.H3` -> both signals present but likely distinct causal variants.

Priors (`p1`, `p2`, `p12`) encode prior probabilities of association and colocalization; they affect posterior values and should be chosen transparently.

## Pipeline components

### `scripts/run_coloc.R`

For each eQTL dataset in `config/eqtl_manifest.tsv` and each GWAS locus:

1. Normalizes GWAS and eQTL columns.
2. Restricts both datasets to locus boundaries.
3. Intersects SNPs (requires minimum overlap; default `--min-overlap-snps 50`).
4. Runs `coloc.abf` and records posterior probabilities plus top SNP by SNP-level PP under H4.

Outputs:

- `output/coloc_results.tsv`
- `output/coloc_strong_hits.tsv` (default `PP.H4 >= 0.8`)

### `scripts/summarize_coloc.R`

Builds a gene-level summary from coloc outputs and optionally merges:

- S-PrediXcan prioritization table
- MAGMA gene evidence

Output:

- `output/summary/coloc_prioritized.tsv`

## Configuration: `config/eqtl_manifest.tsv`

The manifest controls eQTL datasets and column mappings. Required columns include:

- `dataset_id`, `eqtl_file`, `gene`, `tissue`
- plus per-file mapping fields (`snp_col`, `chr_col`, `bp_col`, `beta_col`, `se_col`, `p_col`, etc.)

This makes the script flexible across sources (GTEx, eQTLGen, custom QTL tables).

## Inputs and outputs

### Inputs

- GWAS/MTAG summary statistics (`--gwas`)
- Loci table from fine-mapping (`--loci`)
- eQTL manifest (`--eqtl-manifest`)
- eQTL summary tables referenced by manifest

### Outputs

- Locus-level coloc table with posterior probabilities (`PP.H0`-`PP.H4`)
- Strong hit subset (high `PP.H4`)
- Gene-centric prioritized summary table

## Example usage

```bash
Rscript 5_Colocalization/scripts/run_coloc.R \
  --gwas 3_MTAG/SI/EUR_MM/results/SI_EUR_MM_Output_trait_3.txt \
  --loci 4_Fine_Mapping/output/01_defined_loci/loci.loci.tsv \
  --eqtl-manifest 5_Colocalization/config/eqtl_manifest.tsv \
  --out-dir 5_Colocalization/output

Rscript 5_Colocalization/scripts/summarize_coloc.R
```

## Interpretation guidance

- `PP.H4` is probabilistic evidence, not proof of causality.
- Colocalization can be sensitive to locus definition, SNP overlap, and LD mismatch.
- High `PP.H4` is strongest when supported by independent evidence (fine-mapping PIP, TWAS, MAGMA, biological plausibility).
- If `PP.H3` is high, consider multiple signals or distinct nearby mechanisms.

## References and documentation

- coloc R package: https://chr1swallace.github.io/coloc/
- Giambartolomei et al. (2014), original coloc ABF: https://doi.org/10.1371/journal.pgen.1004383
- Wallace (2020), prior choice and extensions: https://doi.org/10.1371/journal.pgen.1008720
- GTEx portal: https://gtexportal.org/home/
- eQTLGen consortium: https://www.eqtlgen.org/
